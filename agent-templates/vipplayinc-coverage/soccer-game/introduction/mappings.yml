mappings:

  # coverage-event-introduction-service-map
  - type: mapping
    name: coverage-event-introduction-service-map
    title: "Coverage - Event Introduction Service Mapping"
    description: "Mapping data from event introduction service"
    outputs:
      content-group: |
        f"SPORTS_SOCCER_INTRODUCTION"
      content-name: |
        f"{$.('date_prefix')}-{$.('event_title').upper()}-INTRODUCTION"
      content-title: |
        f"{$.('season_title').upper()}-{$.('event_title').upper()}-INTRODUCTION"
      coverage-indexes: |
        [
          {
            "title": f"{$.('team_home_name')} Moment Overview",
            "season_title": "$.('season_title')",
            "event_title": "$.('event_title')",
            "team_name": "$.('team_home_name')",
            "description": f"Moment overview of {$.('team_home_name')} in {$.('season_title')}",
            "index": f"{$.('date_prefix')}-{$.('team_home_name').upper()}-INTRODUCTION-MOMENT_OVERVIEW"
          },
          {
            "title": f"{$.('team_away_name')} Moment Overview",
            "season_title": "$.('season_title')",
            "event_title": "$.('event_title')",
            "team_name": "$.('team_away_name')",
            "description": f"Moment overview of {$.('team_away_name')} in {$.('season_title')}",
            "index": f"{$.('date_prefix')}-{$.('team_away_name').upper()}-INTRODUCTION-MOMENT_OVERVIEW"
          }
        ]

  # coverage-event-introduction-executor-searching-map
  - type: mapping
    name: coverage-event-introduction-executor-searching-map
    title: "Coverage - Event Introduction Executor Mapping"
    description: "Mapping data from event introduction content generation"
    outputs:
      version-control: |
        $.get('_document', {}).get('event-introduction', {}) if $.get('_document') else {}
      version-control-status: |
        $.get('_document', {}).get('event-introduction', {}).get('status', 'pending') if $.get('_document') else 'pending'
      web-search-manual-queries: |
        [
          {
            'metadata': {
              'content-group': $.get('_metadata', {}).get('content-group', ''),
              'content-name': $.get('_metadata', {}).get('content-name', ''),
              'content-topic': $.get('_metadata', {}).get('content-topic', ''),
              'event_code': $.get('_metadata', {}).get('event_code', '')
            },
            'event-introduction': {
              'finished': False,
              'processing': False,
              'updated': datetime.utcnow()
            },
            'web-search-udm': 12,
            'web-search-limit': 4,
            'web-search-topic': 'TEAM_RECENT_NEWS',
            'title': f"(Football) {$.get('_document', {}).get('agenda-object', {}).get('team_home', '')} vs {$.get('_document', {}).get('agenda-object', {}).get('team_away', '')} news after:{(datetime.utcnow() - timedelta(days=3)).strftime('%Y-%m-%d')}",
            'web-search-query': f"(Football) {$.get('_document', {}).get('agenda-object', {}).get('team_home', '')} vs {$.get('_document', {}).get('agenda-object', {}).get('team_away', '')} news after:{(datetime.utcnow() - timedelta(days=3)).strftime('%Y-%m-%d')}"
          },
          {
            'metadata': {
              'content-group': $.get('_metadata', {}).get('content-group', ''),
              'content-name': $.get('_metadata', {}).get('content-name', ''),
              'content-topic': $.get('_metadata', {}).get('content-topic', ''),
              'event_code': $.get('_metadata', {}).get('event_code', '')
            },
            'event-introduction': {
              'finished': False,
              'processing': False,
              'updated': datetime.utcnow()
            },
            'web-search-udm': 1,
            'web-search-limit': 2,
            'web-search-topic': 'TEAM_HISTORIC_ACHIEVEMENTS',
            'title': f"(Football) {$.get('_document', {}).get('agenda-object', {}).get('team_home', '')} vs {$.get('_document', {}).get('agenda-object', {}).get('team_away', '')} historical facts and players in wikipedia",
            'web-search-query': f"(Football) {$.get('_document', {}).get('agenda-object', {}).get('team_home', '')} vs {$.get('_document', {}).get('agenda-object', {}).get('team_away', '')} historical facts and players in wikipedia"
          }
        ]
      web-search-queries: |
        [
          {
            'metadata': {
              'content-group': $.get('_metadata', {}).get('content-group', ''),
              'content-name': $.get('_metadata', {}).get('content-name', ''),
              'content-topic': $.get('_metadata', {}).get('content-topic', ''),
              'event_code': $.get('_metadata', {}).get('event_code', '')
            },
            'version_control': {
              'finished': False,
              'moderated': False,
              'processing': False,
              'updated': datetime.utcnow()
            },
            'title': item.get('title'),
            'web-search-udm': $.get('_document', {}).get('agenda-object', {}).get('web-search-udm', 12),
            'web-search-limit': $.get('_document', {}).get('agenda-object', {}).get('web-search-limit', 10),
            'web-search-topic': item.get('type'),
            'web-search-query': f"{item.get('query')} news source:{item.get('source')}"
          }
          for item in $.get('_document', {}).get('agenda-object', {}).get('search_queries', [])
        ]

  # coverage-event-introduction-websearch-map
  - type: mapping
    name: coverage-event-introduction-websearch-map
    title: "Coverage - Event Introduction Mapping Web Search Items"
    description: "Mapping data from web search items"
    outputs:
      snippets-with-content: |
        [
          item
          for item in $.get('_documents', [])
          if item.get('value', {}).get('content', []) is not None
          and len(item.get('value', {}).get('content', [])) > 0
          and item.get('name', '') == "web-scraping"
        ]
      web-search-items: |
        [
          {
            **d.get('value', {}),
            'metadata': d.get('metadata', {})
          }
          for d in $.get('_documents', [])
          if d.get('name', '') == 'web-scraping'
        ]
      web-search-finished: |
        [
          item
          for item in $.get('_documents', [])
          if item.get('value', {}).get('version_control', {}).get('finished', False) == True
        ]
      web-search-processing: |
        [
          item
          for item in $.get('_documents', [])
          if item.get('value', {}).get('version_control', {}).get('processing', False) == True
        ]
      web-search-pending: |
        [
          item
          for item in $.get('_documents', [])
          if item.get('value', {}).get('version_control', {}).get('finished', False) == False
        ]
      web-search-unmoderated: |
        [
          item
          for item in $.get('_documents', [])
          if (
            item.get('name', '') == 'web-search'
            and item.get('value', {}).get('version_control', {}).get('moderated', False) == False
          )
        ]
      web-search-next-to-be-moderated-count: |
        [
          item
          for item in $.get('_documents', [])
          if (
            item.get('name', '') == 'web-search'
            and item.get('value', {}).get('version_control', {}).get('moderated', False) == False
            and item.get('value', {}).get('version_control', {}).get('finished', False) == True
          )
        ]
      web-search-next-to-be-moderated: |
        next(
          (
            item
            for item in $.get('_documents', [])
            if (
              item.get('name', '') == 'web-search'
              and item.get('value', {}).get('version_control', {}).get('moderated', False) == False
              and item.get('value', {}).get('version_control', {}).get('finished', False) == True
            )
          ),
          None
        )